<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholarship Game Plan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for light theme and glassy effects */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #F0F4F8, #E2E8F0); /* Light theme background */
            color: #333; /* Default text color for light theme */
        }

        /* Glassy Panel Styling */
        .glass-panel {
            background: rgba(255, 255, 255, 0.5); /* 50% opaque white */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Lighter border */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            padding: 1.5rem;
            margin: 1.5rem;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05); /* Lighter track */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2); /* Lighter thumb */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* Subtle Background Pulse Animation */
        .animate-pulse-bg {
            animation: pulse-bg 30s infinite alternate;
        }
        @keyframes pulse-bg {
            0% { transform: scale(1); opacity: 0.05; }
            50% { transform: scale(1.02); opacity: 0.1; }
            100% { transform: scale(1); opacity: 0.05; }
        }

        /* Preloader Styles */
        #pre-load {
            background: linear-gradient(135deg, #F0F4F8, #E2E8F0); /* Light theme background */
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
        }
        #pre-load .loader-inner {
            --loader-background: linear-gradient(0deg, rgba(200,200,200,.2) 0%, rgba(240,240,240,.2) 100%); /* Lighter glassy background */
            position: relative;
            height: 250px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #pre-load .loader-inner .loader-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: color-change 2s infinite ease-in-out;
            z-index: 999;
            /* Custom LM styling */
            font-family: 'Inter', sans-serif;
            font-weight: bold;
            font-size: 2.5rem;
            color: #3B82F6; /* A prominent blue */
            background: rgba(255, 255, 255, 0.8); /* Slightly opaque white background for text */
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); /* Blue glow */
        }
        #pre-load .loader-inner .loader-logo svg { /* Hide SVG as we're using text */
            display: none;
        }
        #pre-load .loader-inner .box {
            position: absolute;
            background: var(--loader-background);
            border-radius: 50%;
            border-top: 1px solid rgba(150,150,150,0.4); /* Lighter border */
            box-shadow: rgba(0,0,0,.1) 0 10px 10px 0; /* Lighter shadow */
            backdrop-filter: blur(5px);
            animation: ripple 2s infinite ease-in-out;
        }
        #pre-load .loader-inner .box:nth-child(1) {
            width: 25%;
            aspect-ratio: 1/1;
            z-index: 99;
        }
        #pre-load .loader-inner .box:nth-child(2) {
            inset: 30%;
            z-index: 98;
            border-color: rgba(150,150,150,.6); /* Lighter border */
            animation-delay: .2s;
        }
        #pre-load .loader-inner .box:nth-child(3) {
            inset: 20%;
            z-index: 97;
            border-color: rgba(150,150,150,.8); /* Lighter border */
            animation-delay: .4s;
        }
        #pre-load .loader-inner .box:nth-child(4) {
            inset: 10%;
            z-index: 96;
            border-color: rgba(150,150,150,1); /* Lighter border */
            animation-delay: .6s;
        }
        #pre-load .loader-inner .box:nth-child(5) {
            inset: 0;
            z-index: 95;
            border-color: rgba(150,150,150,.2); /* Lighter border */
            animation-delay: .8s;
        }
        @keyframes ripple {
            0% {
                transform: scale(1);
                box-shadow: rgba(0,0,0,.1) 0 10px 10px 0; /* Lighter shadow */
            }
            50% {
                transform: scale(1.3);
                box-shadow: rgba(0,0,0,.1) 0 30px 20px 0; /* Lighter shadow */
            }
            100% {
                transform: scale(1);
                box-shadow: rgba(0,0,0,.1) 0 10px 10px 0; /* Lighter shadow */
            }
        }
        @keyframes color-change {
            0% {
                opacity: .7;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: .7;
            }
        }
    </style>
</head>
<body>
    <!-- Preloader HTML -->
    <div id="pre-load" class="loader">
        <div class="loader-inner">
            <div class="loader-logo">
                LM
            </div>
            <div class="box"></div>
            <div class="box"></div>
            <div class="box"></div>
            <div class="box"></div>
            <div class="box"></div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen flex flex-col items-center p-4 relative overflow-hidden hidden">
        <!-- Subtle Space Background -->
        <div class="absolute inset-0 z-0 opacity-10">
            <div class="absolute inset-0 bg-[url('https://placehold.co/1920x1080/E0F2F7/000?text=Subtle+Space')] bg-cover bg-center animate-pulse-bg"></div>
            <div class="absolute inset-0 bg-gradient-to-br from-transparent via-blue-100/50 to-transparent"></div>
        </div>

        <div class="relative z-10 w-full max-w-7xl flex flex-col lg:flex-row gap-6">
            <!-- Sidebar / Navigation -->
            <div class="w-full lg:w-64 bg-white/50 backdrop-blur-lg border border-gray-300 rounded-xl shadow-lg p-4 flex flex-col items-center">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-800 mb-6 mt-2">
                    Scholarship Hub
                </h1>
                <nav class="flex lg:flex-col flex-wrap justify-center lg:justify-start gap-2 w-full">
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105 active-tab" data-tab="dashboard">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        Dashboard
                    </button>
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105" data-tab="scholarships">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        Scholarships
                    </button>
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105" data-tab="timeline">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Timeline
                    </button>
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105" data-tab="dailyRoutine">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                        Daily Routine
                    </button>
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105" data-tab="documentChecklist">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-square"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Documents
                    </button>
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105" data-tab="contactsNotes">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Contacts & Notes
                    </button>
                    <button class="nav-item flex items-center w-full px-4 py-3 rounded-lg text-left font-medium transition-all duration-200 transform hover:scale-105" data-tab="liveUpdates">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                        Live Updates
                    </button>
                </nav>
                <div id="user-id-display" class="mt-8 text-sm text-gray-500 text-center break-all hidden">
                    Your User ID:<br />
                    <span class="font-mono text-xs" id="user-id-text"></span>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 bg-white/50 backdrop-blur-lg border border-gray-300 rounded-xl shadow-lg p-6 min-h-[calc(100vh-8rem)]">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="current-tab-title" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-cyan-800"></h2>
                    <button id="add-new-button" class="flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md transform hover:scale-105 hidden">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M12 5V19"/><path d="M5 12H19"/></svg> Add New
                    </button>
                </div>

                <!-- Reminder Popover -->
                <div id="reminder-popover" class="fixed bottom-4 right-4 z-50 hidden">
                    <button id="reminder-button" class="bg-red-600 text-white rounded-full p-4 shadow-lg animate-bounce flex items-center justify-center text-sm font-bold" title="Daily Reminders">
                        <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg> <span id="reminder-count">0</span>
                    </button>
                </div>

                <div id="reminder-panel" class="fixed bottom-4 right-4 z-50 w-80 bg-white/70 backdrop-blur-xl border border-gray-300 rounded-lg shadow-xl p-4 text-gray-800 hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-red-600">Today's Reminders</h3>
                        <button id="close-reminder-panel" class="text-gray-600 hover:text-gray-800">
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                        </button>
                    </div>
                    <ul id="reminder-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-2"></ul>
                    <p id="no-reminders-msg" class="text-gray-500 text-sm hidden">No upcoming tasks for today.</p>
                </div>

                <!-- Content Area for Tabs -->
                <div id="dashboard-content" class="tab-content"></div>
                <div id="scholarships-content" class="tab-content hidden"></div>
                <div id="timeline-content" class="tab-content hidden"></div>
                <div id="dailyRoutine-content" class="tab-content hidden"></div>
                <div id="documentChecklist-content" class="tab-content hidden"></div>
                <div id="contactsNotes-content" class="tab-content hidden"></div>
                <div id="liveUpdates-content" class="tab-content hidden"></div>
            </div>
        </div>
    </div>

    <!-- Data Modal HTML -->
    <div id="data-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto hidden">
        <div class="glass-panel w-full max-w-lg mx-auto p-6 relative bg-white/70">
            <button id="modal-close-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold text-blue-700 mb-6 text-center"></h3>
            <div id="modal-message-box" class="hidden mb-4 text-red-600 text-center font-semibold"></div>
            <form id="data-form" class="space-y-4"></form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables for Firebase instances and user data
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let loading = true;
        let currentError = null;
        const notifiedTasks = new Set(); // To prevent re-notifying for the same task

        // Helper for exponential backoff
        const exponentialBackoff = async (fn, retries = 5, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i < retries - 1) {
                        console.warn(`Retry ${i + 1}/${retries} after error:`, error);
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        throw error; // Re-throw after last retry
                    }
                }
            }
        };

        // --- Data Storage Variables (global, to be populated by Firestore) ---
        let scholarshipsData = [];
        let timelineData = [];
        let dailyRoutineData = [];
        let documentChecklistData = [];
        let contactsNotesData = [];

        // --- UI Elements ---
        const preLoadDiv = document.getElementById('pre-load');
        const appDiv = document.getElementById('app');
        const userIdDisplay = document.getElementById('user-id-display');
        const userIdText = document.getElementById('user-id-text');
        const navItems = document.querySelectorAll('.nav-item');
        const currentTabTitle = document.getElementById('current-tab-title');
        const addNewButton = document.getElementById('add-new-button');

        const dataModal = document.getElementById('data-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalTitle = document.getElementById('modal-title');
        const modalMessageBox = document.getElementById('modal-message-box');
        const dataForm = document.getElementById('data-form');

        const reminderPopover = document.getElementById('reminder-popover');
        const reminderButton = document.getElementById('reminder-button');
        const reminderCount = document.getElementById('reminder-count');
        const reminderPanel = document.getElementById('reminder-panel');
        const closeReminderPanelButton = document.getElementById('close-reminder-panel');
        const reminderList = document.getElementById('reminder-list');
        const noRemindersMsg = document.getElementById('no-reminders-msg');

        let activeTab = 'dashboard'; // Initial active tab
        let currentModalType = ''; // Tracks type of data being added/edited in modal
        let currentModalData = null; // Tracks data for editing in modal

        // --- Initial App Setup on Window Load ---
        window.onload = async function() {
            try {
                // Initialize Firebase
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        try {
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            currentUserId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback for anonymous
                        } catch (signInError) {
                            console.error("Firebase Anonymous/Custom Sign-in Error:", signInError);
                            currentError = "Failed to sign in. Please check console for details.";
                        }
                    }
                    loading = false;
                    renderApp(); // Render after authentication
                });

                // Request notification permission
                if ('Notification' in window) {
                    Notification.requestPermission();
                }

                // Set up event listeners
                setupEventListeners();

            } catch (initError) {
                console.error("Firebase Initialization Error:", initError);
                currentError = "Failed to initialize Firebase. Please check console.";
                loading = false;
                renderApp(); // Render with error state
            }
        };

        function renderApp() {
            if (loading) {
                preLoadDiv.classList.remove('hidden');
                appDiv.classList.add('hidden');
            } else {
                preLoadDiv.classList.add('hidden');
                appDiv.classList.remove('hidden');

                if (currentError) {
                    appDiv.innerHTML = `
                        <div class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-red-100 to-red-200 text-red-700 p-4 w-full">
                            <div class="text-xl font-semibold mb-4">Error: ${currentError}</div>
                            <p class="text-gray-600 text-center">Please check your console for more details or try refreshing the page.</p>
                        </div>
                    `;
                    return;
                }

                if (currentUserId) {
                    userIdDisplay.classList.remove('hidden');
                    userIdText.textContent = currentUserId;
                    setupRealtimeListeners();
                    setInterval(updateReminders, 60 * 1000); // Check reminders every minute
                } else {
                    userIdDisplay.classList.add('hidden');
                }

                switchTab(activeTab); // Render initial tab content
            }
        }

        // --- Firebase Realtime Listeners ---
        function setupRealtimeListeners() {
            if (!db || !currentUserId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userPath = `/artifacts/${appId}/users/${currentUserId}`;

            const collections = {
                scholarships: (data) => { scholarshipsData = data; renderTabContent(activeTab); },
                timeline: (data) => { timelineData = data; renderTabContent(activeTab); },
                dailyRoutine: (data) => { dailyRoutineData = data; renderTabContent(activeTab); updateReminders(); },
                documentChecklist: (data) => { documentChecklistData = data; renderTabContent(activeTab); },
                contactsNotes: (data) => { contactsNotesData = data; renderTabContent(activeTab); },
            };

            for (const name in collections) {
                const colRef = collection(db, `${userPath}/${name}`);
                onSnapshot(colRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    collections[name](data); // Call the setter function
                }, (err) => {
                    console.error(`Error fetching ${name}:`, err);
                    currentError = `Failed to load ${name} data.`;
                    renderApp();
                });
            }
        }

        // --- Navigation and Tab Switching ---
        function setupEventListeners() {
            navItems.forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    switchTab(tab);
                });
            });

            addNewButton.addEventListener('click', () => openModal(activeTab.replace(/s$/, '')));
            modalCloseButton.addEventListener('click', closeModal);
            reminderButton.addEventListener('click', () => {
                reminderPanel.classList.toggle('hidden');
                reminderPopover.classList.toggle('hidden');
            });
            closeReminderPanelButton.addEventListener('click', () => {
                reminderPanel.classList.add('hidden');
                reminderPopover.classList.remove('hidden');
            });
        }

        function switchTab(tabName) {
            // Hide all tab content and remove active class from nav items
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            navItems.forEach(button => button.classList.remove('bg-blue-200', 'bg-opacity-70', 'text-blue-800', 'shadow-inner-lg', 'active-tab'));
            navItems.forEach(button => button.classList.add('text-gray-600', 'hover:bg-white/70', 'hover:text-gray-900'));


            // Show active tab content and add active class to nav item
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`.nav-item[data-tab="${tabName}"]`).classList.add('bg-blue-200', 'bg-opacity-70', 'text-blue-800', 'shadow-inner-lg', 'active-tab');
            document.querySelector(`.nav-item[data-tab="${tabName}"]`).classList.remove('text-gray-600', 'hover:bg-white/70', 'hover:text-gray-900');

            activeTab = tabName;
            currentTabTitle.textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1).replace(/([A-Z])/g, ' $1');

            // Show/hide Add New button based on tab
            if (activeTab === 'dashboard' || activeTab === 'liveUpdates') {
                addNewButton.classList.add('hidden');
            } else {
                addNewButton.classList.remove('hidden');
            }
            renderTabContent(activeTab);
        }

        function renderTabContent(tabName) {
            const contentDiv = document.getElementById(`${tabName}-content`);
            contentDiv.innerHTML = ''; // Clear previous content

            let html = '';
            switch (tabName) {
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'scholarships':
                    html = renderTable(scholarshipsData, 'scholarship', [
                        { key: 'Scholarship', header: 'Scholarship', class: 'font-semibold text-blue-700' },
                        { key: 'Country/Region', header: 'Country/Region' },
                        { key: 'Level', header: 'Level' },
                        { key: 'Fit for You', header: 'Fit' },
                        { key: 'Suggested Fields', header: 'Fields' },
                        { key: 'Funding Snapshot', header: 'Funding' },
                    ]);
                    break;
                case 'timeline':
                    const sortedTimeline = [...timelineData].sort((a, b) => new Date(a['Target Date']) - new Date(b['Target Date']));
                    html = renderTable(sortedTimeline, 'timeline', [
                        { key: 'Milestone', header: 'Milestone', class: 'font-semibold text-green-700' },
                        { key: 'Scheme/Area', header: 'Scheme/Area' },
                        { key: 'Target Date', header: 'Target Date', formatter: (val) => new Date(val).toLocaleDateString() },
                        { key: 'Priority', header: 'Priority' },
                        { key: 'Notes', header: 'Notes' },
                    ]);
                    break;
                case 'dailyRoutine':
                    const sortedDailyRoutine = [...dailyRoutineData].sort((a, b) => {
                        const dateA = new Date(a.Date);
                        const dateB = new Date(b.Date);
                        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                        const timeA = a.Time?.split('–')[0]?.split(':').map(Number);
                        const timeB = b.Time?.split('–')[0]?.split(':').map(Number);
                        if (timeA && timeB) return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                        return 0;
                    });
                    html = renderTable(sortedDailyRoutine, 'dailyRoutine', [
                        { key: 'Date', header: 'Date', formatter: (val) => new Date(val).toLocaleDateString() },
                        { key: 'Weekday', header: 'Weekday' },
                        { key: 'Time', header: 'Time' },
                        { key: 'Activity', header: 'Activity', class: 'font-semibold text-purple-700' },
                        { key: 'Notes', header: 'Notes' },
                    ]);
                    break;
                case 'documentChecklist':
                    html = renderDocumentChecklist();
                    break;
                case 'contactsNotes':
                    html = renderTable(contactsNotesData, 'contactsNotes', [
                        { key: 'Contact', header: 'Contact', class: 'font-semibold text-pink-700' },
                        { key: 'Type', header: 'Type' },
                        { key: 'Channel', header: 'Channel' },
                        { key: 'Notes', header: 'Notes' },
                    ]);
                    break;
                case 'liveUpdates':
                    html = renderLiveUpdates();
                    break;
                default:
                    html = '<p class="text-gray-500">Select a tab to view content.</p>';
            }
            contentDiv.innerHTML = html;
            // Attach event listeners to newly rendered elements (e.g., action buttons)
            attachActionListeners(tabName);
            // Re-attach status change listeners for document checklist
            if (tabName === 'documentChecklist') {
                document.querySelectorAll('.status-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async (e) => {
                        const itemId = e.target.dataset.id;
                        const item = documentChecklistData.find(d => d.id === itemId);
                        if (item) {
                            const newStatus = e.target.checked ? 'Completed' : 'In progress';
                            await handleSave({ ...item, Status: newStatus });
                        }
                    });
                });
            }
        }

        // --- Rendering Functions for each tab ---

        function renderDashboard() {
            const upcomingTimeline = timelineData
                .filter(item => new Date(item['Target Date']) >= new Date())
                .sort((a, b) => new Date(a['Target Date']) - new Date(b['Target Date']))
                .slice(0, 3); // Show top 3 upcoming

            const pendingDocuments = documentChecklistData.filter(item => item.Status !== 'Completed' && item.Status !== 'In hand').slice(0, 5); // Show top 5 pending

            const today = new Date().toISOString().slice(0, 10);
            const todayRoutine = dailyRoutineData.filter(item => item.Date?.startsWith(today))
                .sort((a, b) => {
                    const timeA = a.Time?.split('–')[0]?.split(':').map(Number);
                    const timeB = b.Time?.split('–')[0]?.split(':').map(Number);
                    if (timeA && timeB) {
                        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                    }
                    return 0;
                })
                .slice(0, 5); // Show top 5 for today

            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel">
                        <h3 class="text-xl font-bold text-blue-700 mb-4">Overall Progress</h3>
                        <div class="space-y-3 text-gray-700">
                            <p>Scholarships Tracked: <span class="font-semibold text-purple-800">${scholarshipsData.length}</span></p>
                            <p>Milestones Defined: <span class="font-semibold text-purple-800">${timelineData.length}</span></p>
                            <p>Documents Checklist: <span class="font-semibold text-purple-800">${documentChecklistData.filter(d => d.Status === 'Completed').length} / ${documentChecklistData.length} completed</span></p>
                            <p>Contacts Recorded: <span class="font-semibold text-purple-800">${contactsNotesData.length}</span></p>
                        </div>
                    </div>

                    <div class="glass-panel">
                        <h3 class="text-xl font-bold text-green-700 mb-4">Upcoming Milestones</h3>
                        ${upcomingTimeline.length > 0 ? `
                            <ul class="space-y-2">
                                ${upcomingTimeline.map(item => `
                                    <li class="text-gray-700 text-sm bg-white/70 p-3 rounded-md border border-gray-200">
                                        <p class="font-semibold text-yellow-800">${item.Milestone}</p>
                                        <p class="text-gray-600">Target: ${new Date(item['Target Date']).toLocaleDateString()}</p>
                                        <p class="text-gray-500 text-xs">Priority: ${item.Priority}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : `<p class="text-gray-500">No upcoming milestones.</p>`}
                    </div>

                    <div class="glass-panel lg:col-span-2">
                        <h3 class="text-xl font-bold text-cyan-700 mb-4">Key Document Status</h3>
                        ${pendingDocuments.length > 0 ? `
                            <ul class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${pendingDocuments.map(item => `
                                    <li class="text-gray-700 text-sm bg-white/70 p-3 rounded-md border border-gray-200">
                                        <p class="font-semibold text-pink-700">${item.Item}</p>
                                        <p class="text-gray-600">Status: ${item.Status}</p>
                                        ${item.Notes ? `<p class="text-gray-500 text-xs">Notes: ${item.Notes}</p>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : `<p class="text-gray-500">All key documents are up-to-date or in hand!</p>`}
                    </div>

                    <div class="glass-panel lg:col-span-2">
                        <h3 class="text-xl font-bold text-yellow-700 mb-4">Today's Routine At A Glance</h3>
                        ${todayRoutine.length > 0 ? `
                            <ul class="space-y-2">
                                ${todayRoutine.map(item => `
                                    <li class="text-gray-700 text-sm bg-white/70 p-3 rounded-md border border-gray-200">
                                        <p class="font-semibold text-purple-700">${item.Activity}</p>
                                        <p class="text-gray-600">Time: ${item.Time}</p>
                                        ${item.Notes ? `<p class="text-gray-500 text-xs">Notes: ${item.Notes}</p>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : `<p class="text-gray-500">No routine activities scheduled for today.</p>`}
                    </div>
                </div>
            `;
        }

        function renderTable(data, type, headers) {
            if (data.length === 0) {
                return `<div class="glass-panel"><p class="text-center text-gray-500 mt-4">No ${type.replace(/s$/, '')}s added yet.</p></div>`;
            }

            return `
                <div class="glass-panel">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full table-auto">
                            <thead>
                                <tr>
                                    ${headers.map(h => `<th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">${h.header}</th>`).join('')}
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr class="border-b border-gray-300 hover:bg-gray-100/50 transition-colors duration-200">
                                        ${headers.map(h => `
                                            <td class="px-4 py-3 text-sm text-gray-700 ${h.class || ''}">
                                                ${h.formatter ? h.formatter(item[h.key]) : item[h.key] || ''}
                                            </td>
                                        `).join('')}
                                        <td class="px-4 py-3 text-sm text-gray-700">
                                            <div class="flex space-x-2">
                                                <button class="edit-btn p-2 rounded-full bg-blue-500 hover:bg-blue-600 transition-colors duration-200 shadow-md" data-id="${item.id}" data-type="${type}" title="Edit">
                                                    <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                </button>
                                                <button class="delete-btn p-2 rounded-full bg-red-500 hover:bg-red-600 transition-colors duration-200 shadow-md" data-id="${item.id}" data-type="${type}" title="Delete">
                                                    <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderDocumentChecklist() {
            if (documentChecklistData.length === 0) {
                return `<div class="glass-panel"><p class="text-center text-gray-500 mt-4">No document checklist items added yet.</p></div>`;
            }
            return `
                <div class="glass-panel">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full table-auto">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">Notes</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase text-gray-500">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${documentChecklistData.map(item => `
                                    <tr class="border-b border-gray-300 hover:bg-gray-100/50 transition-colors duration-200">
                                        <td class="px-4 py-3 text-sm text-gray-700 font-semibold text-orange-700">
                                            <input type="checkbox" class="status-checkbox mr-2 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 bg-gray-200 border-gray-300" data-id="${item.id}" ${item.Status === 'Completed' ? 'checked' : ''}>
                                            ${item.Item}
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700">${item.Category}</td>
                                        <td class="px-4 py-3 text-sm text-gray-700">
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold
                                                ${item.Status === 'Completed' ? 'bg-green-600 text-white' :
                                                  item.Status === 'In progress' ? 'bg-yellow-600 text-white' :
                                                  'bg-gray-600 text-white'}">
                                                ${item.Status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700">${item.Notes || ''}</td>
                                        <td class="px-4 py-3 text-sm text-gray-700">
                                            <div class="flex space-x-2">
                                                <button class="edit-btn p-2 rounded-full bg-blue-500 hover:bg-blue-600 transition-colors duration-200 shadow-md" data-id="${item.id}" data-type="documentChecklist" title="Edit">
                                                    <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                </button>
                                                <button class="delete-btn p-2 rounded-full bg-red-500 hover:bg-red-600 transition-colors duration-200 shadow-md" data-id="${item.id}" data-type="documentChecklist" title="Delete">
                                                    <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderLiveUpdates() {
            const mockIELTSUpdates = [
                { id: 1, title: "IELTS Test Dates Q4 2025 Released", snippet: "New test dates for October, November, December 2025 are now available. Book early to secure your slot.", link: "https://www.ielts.org/news/q4-dates-2025" },
                { id: 2, title: "New IELTS Speaking Topics for September", snippet: "Examiners will introduce new topics for the speaking section starting September 1st.", link: "https://www.ielts.org/updates/speaking-topics" },
                { id: 3, title: "Online IELTS Practice Tests Updated", snippet: "Free online practice tests for Academic and General Training modules have been refreshed.", link: "https://www.ielts.org/prepare/online-tests" },
            ];

            const mockScholarshipUpdates = scholarshipsData.slice(0, 3).map((scholarship, index) => ({
                id: scholarship.id,
                title: `${scholarship.Scholarship} - New Deadline!`,
                snippet: `The application deadline for ${scholarship.Scholarship} has been extended to ${new Date(new Date().setMonth(new Date().getMonth() + 1 + index)).toLocaleDateString()}. Don't miss out! Check eligibility criteria.`,
                link: scholarship['Official Link'] || `https://example.com/scholarship-update-${index}`
            }));

            return `
                <div class="glass-panel">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">Online Scholarship Updates (Simulated)</h3>
                    <p class="text-gray-600 mb-6">
                        <strong class="text-blue-800">Note:</strong> For actual real-time updates from various online sources (like scholarship portals or news sites), a backend service or cloud function (e.g., Google Cloud Functions, AWS Lambda) would be required. This backend would use web scraping libraries or APIs (like Google Search's custom search API) to fetch and parse the latest information, which would then be delivered to this frontend. The updates below are simulated to demonstrate the concept.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-purple-700 mb-3">Scholarship Deadlines & Perks</h4>
                            ${mockScholarshipUpdates.length > 0 ? `
                                <ul class="space-y-4">
                                    ${mockScholarshipUpdates.map(update => `
                                        <li class="bg-white/70 p-4 rounded-md border border-gray-200 shadow-sm">
                                            <a href="${update.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold text-lg block mb-1">
                                                ${update.title}
                                            </a>
                                            <p class="text-gray-700 text-sm">${update.snippet}</p>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `<p class="text-gray-500">No scholarships to show simulated updates for. Add some scholarships first!</p>`}
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-teal-700 mb-3">IELTS Updates</h4>
                            ${mockIELTSUpdates.length > 0 ? `
                                <ul class="space-y-4">
                                    ${mockIELTSUpdates.map(update => `
                                        <li class="bg-white/70 p-4 rounded-md border border-gray-200 shadow-sm">
                                            <a href="${update.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold text-lg block mb-1">
                                                ${update.title}
                                            </a>
                                            <p class="text-gray-700 text-sm">${update.snippet}</p>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : `<p class="text-gray-500">No IELTS updates available.</p>`}
                        </div>
                    </div>
                </div>
            `;
        }


        // --- Modals and Forms ---
        const fieldDefinitions = {
            scholarship: [
                { name: 'Scholarship', label: 'Scholarship Name', type: 'text', required: true },
                { name: 'Country/Region', label: 'Country/Region', type: 'text' },
                { name: 'Level', label: 'Level (e.g., Master\'s, PhD)', type: 'text' },
                { name: 'Fit for You', label: 'Fit for You (e.g., High, Medium, Low)', type: 'text' },
                { name: 'Suggested Fields', label: 'Suggested Fields', type: 'text' },
                { name: 'Funding Snapshot', label: 'Funding Snapshot', type: 'textarea' },
                { name: 'Application Route', label: 'Application Route', type: 'textarea' },
                { name: 'Official Link', label: 'Official Link', type: 'url' },
            ],
            timeline: [
                { name: 'Milestone', label: 'Milestone', type: 'text', required: true },
                { name: 'Scheme/Area', label: 'Scheme/Area', type: 'text' },
                { name: 'Target Date', label: 'Target Date', type: 'date', required: true },
                { name: 'Priority', label: 'Priority (e.g., High, Medium, Low)', type: 'text' },
                { name: 'Notes', label: 'Notes', type: 'textarea' },
            ],
            dailyRoutine: [
                { name: 'Date', label: 'Date', type: 'date', required: true },
                { name: 'Weekday', label: 'Weekday', type: 'text', required: true },
                { name: 'Time', label: 'Time (e.g., 09:00–10:00)', type: 'text', required: true },
                { name: 'Activity', label: 'Activity', type: 'text', required: true },
                { name: 'Notes', label: 'Notes', type: 'textarea' },
            ],
            documentChecklist: [
                { name: 'Item', label: 'Document Item', type: 'text', required: true },
                { name: 'Category', label: 'Category', type: 'text' },
                { name: 'Status', label: 'Status (e.g., In hand, Pending, Completed)', type: 'text' },
                { name: 'Notes', label: 'Notes', type: 'textarea' },
            ],
            contactsNotes: [
                { name: 'Contact', label: 'Contact Name/Entity', type: 'text', required: true },
                { name: 'Type', label: 'Type (e.g., Academic, Professional, Agency)', type: 'text' },
                { name: 'Channel', label: 'Channel (e.g., Email, Portal)', type: 'text' },
                { name: 'Notes', label: 'Notes', type: 'textarea' },
            ],
        };

        function openModal(type, data = null) {
            currentModalType = type;
            currentModalData = data;

            modalTitle.textContent = `${data ? 'Edit' : 'Add New'} ${type.charAt(0).toUpperCase() + type.slice(1).replace(/([A-Z])/g, ' $1')}`;
            modalMessageBox.classList.add('hidden'); // Hide message box on open

            let formHtml = '';
            const fields = fieldDefinitions[type];
            let initialFormData = {};

            if (data) {
                // Pre-fill form for editing
                for (const field of fields) {
                    if (field.type === 'date' && data[field.name]) {
                        initialFormData[field.name] = new Date(data[field.name]).toISOString().split('T')[0];
                    } else {
                        initialFormData[field.name] = data[field.name] || '';
                    }
                }
                initialFormData.id = data.id; // Preserve ID for update
            } else {
                // Default values for new entry
                for (const field of fields) {
                    if (field.type === 'date') {
                        initialFormData[field.name] = new Date().toISOString().split('T')[0];
                    } else {
                        initialFormData[field.name] = '';
                    }
                }
            }

            for (const field of fields) {
                const value = initialFormData[field.name];
                formHtml += `
                    <div>
                        <label for="modal-${field.name}" class="block text-gray-700 text-sm font-medium mb-1">
                            ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                        </label>
                        ${field.type === 'textarea' ? `
                            <textarea id="modal-${field.name}" name="${field.name}" class="w-full p-3 bg-white/70 border border-gray-300 rounded-md text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-y min-h-[60px]" rows="3">${value}</textarea>
                        ` : `
                            <input type="${field.type}" id="modal-${field.name}" name="${field.name}" value="${value}" class="w-full p-3 bg-white/70 border border-gray-300 rounded-md text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" ${field.required ? 'required' : ''}>
                        `}
                    </div>
                `;
            }

            formHtml += `
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="form-cancel-button" class="px-6 py-3 rounded-md font-semibold text-gray-700 border border-gray-400 hover:bg-gray-100 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="form-save-button" class="px-6 py-3 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200 shadow-md transform hover:scale-105">
                        Save
                    </button>
                </div>
            `;
            dataForm.innerHTML = formHtml;
            dataModal.classList.remove('hidden');

            // Attach event listeners for the new form
            document.getElementById('form-cancel-button').addEventListener('click', closeModal);
            dataForm.removeEventListener('submit', handleFormSubmit); // Remove old listener to prevent duplicates
            dataForm.addEventListener('submit', handleFormSubmit);
        }

        function closeModal() {
            dataModal.classList.add('hidden');
            currentModalData = null;
            currentModalType = '';
            dataForm.reset(); // Clear form
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const formData = {};
            const fields = fieldDefinitions[currentModalType];

            for (const field of fields) {
                const inputElement = dataForm.querySelector(`#modal-${field.name}`);
                if (inputElement) {
                    if (field.required && !inputElement.value) {
                        modalMessageBox.textContent = `${field.label} is required.`;
                        modalMessageBox.classList.remove('hidden');
                        inputElement.focus();
                        return;
                    }
                    formData[field.name] = inputElement.value;
                }
            }

            // Add ID if editing
            if (currentModalData && currentModalData.id) {
                formData.id = currentModalData.id;
            }

            await handleSave(formData);
        }

        async function handleSave(data) {
            if (!db || !currentUserId) {
                modalMessageBox.textContent = "Database not ready. Please try again.";
                modalMessageBox.classList.remove('hidden');
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userPath = `/artifacts/${appId}/users/${currentUserId}`;
            const collectionName = currentModalType + 's'; // e.g., 'scholarships', 'timelines'

            try {
                if (data.id) {
                    // Update existing document
                    const docRef = doc(db, `${userPath}/${collectionName}`, data.id);
                    await exponentialBackoff(() => setDoc(docRef, data)); // Use setDoc to replace, updateDoc to merge
                    console.log("Document updated with ID:", data.id);
                } else {
                    // Add new document
                    const colRef = collection(db, `${userPath}/${collectionName}`);
                    const docRef = await exponentialBackoff(() => addDoc(colRef, data));
                    console.log("Document written with ID:", docRef.id);
                }
                closeModal();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                modalMessageBox.textContent = "Failed to save data. " + e.message;
                modalMessageBox.classList.remove('hidden');
            }
        }

        async function handleDelete(type, id) {
            if (!db || !currentUserId) {
                alert("Database not ready. Please try again."); // Using alert for simplicity in this pure JS context
                return;
            }

            const confirmDelete = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4";
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-gray-800 max-w-sm w-full border border-gray-200 backdrop-blur-md bg-opacity-90">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Confirm Deletion</h3>
                        <p class="mb-6 text-gray-700">Are you sure you want to delete this item? This action cannot be undone.</p>
                        <div class="flex justify-end space-x-4">
                            <button id="cancel-btn-confirm" class="px-5 py-2 rounded-md font-semibold text-gray-700 border border-gray-300 hover:bg-gray-100 transition-colors">Cancel</button>
                            <button id="delete-btn-confirm" class="px-5 py-2 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700 transition-colors">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('cancel-btn-confirm').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(false);
                };
                document.getElementById('delete-btn-confirm').onclick = () => {
                    document.body.removeChild(modal);
                    resolve(true);
                };
            });

            if (!confirmDelete) return;


            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userPath = `/artifacts/${appId}/users/${currentUserId}`;
            const collectionName = type + 's';

            try {
                const docRef = doc(db, `${userPath}/${collectionName}`, id);
                await exponentialBackoff(() => deleteDoc(docRef));
                console.log("Document deleted successfully");
            } catch (e) {
                console.error("Error deleting document: ", e);
                alert("Failed to delete data. " + e.message); // Using alert for simplicity
            }
        }

        function attachActionListeners(tabName) {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    let itemToEdit = null;
                    if (type === 'scholarship') itemToEdit = scholarshipsData.find(item => item.id === id);
                    else if (type === 'timeline') itemToEdit = timelineData.find(item => item.id === id);
                    else if (type === 'dailyRoutine') itemToEdit = dailyRoutineData.find(item => item.id === id);
                    else if (type === 'documentChecklist') itemToEdit = documentChecklistData.find(item => item.id === id);
                    else if (type === 'contactsNotes') itemToEdit = contactsNotesData.find(item => item.id === id);
                    if (itemToEdit) openModal(type, itemToEdit);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    handleDelete(type, id);
                });
            });
        }

        // --- Reminder Logic ---
        function updateReminders() {
            const now = new Date();
            const today = now.toISOString().slice(0, 10); // YYYY-MM-DD
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            const upcomingTasks = dailyRoutineData
                .filter(item => {
                    const itemDate = item.Date ? new Date(item.Date).toISOString().slice(0, 10) : '';
                    return itemDate === today;
                })
                .map(item => {
                    const timeParts = item.Time?.split('–')[0]?.split(':');
                    if (timeParts && timeParts.length === 2) {
                        const itemHour = parseInt(timeParts[0]);
                        const itemMinute = parseInt(timeParts[1]);
                        const timeDifferenceMinutes = (itemHour * 60 + itemMinute) - (currentHour * 60 + currentMinute);
                        return {
                            ...item,
                            timeInMinutes: (itemHour * 60 + itemMinute),
                            isUpcoming: timeDifferenceMinutes >= 0 && timeDifferenceMinutes <= 15
                        };
                    }
                    return { ...item, isUpcoming: false };
                })
                .filter(item => item.isUpcoming)
                .sort((a, b) => a.timeInMinutes - b.timeInMinutes);

            // Update reminder count and visibility
            if (upcomingTasks.length > 0) {
                reminderCount.textContent = upcomingTasks.length;
                reminderPopover.classList.remove('hidden');
                // Ensure panel is hidden if popover is shown first
                if (reminderPanel.classList.contains('hidden')) {
                     reminderPopover.classList.remove('hidden');
                }
            } else {
                reminderPopover.classList.add('hidden');
                reminderPanel.classList.add('hidden'); // Also hide panel if no reminders
            }

            // Populate reminder panel
            if (upcomingTasks.length > 0) {
                reminderList.innerHTML = upcomingTasks.map(task => `
                    <li class="bg-white/50 p-3 rounded-md border border-gray-200 text-sm">
                        <p class="font-semibold text-purple-700">${task.Activity}</p>
                        <p class="text-gray-600 text-xs">Time: ${task.Time}</p>
                        ${task.Notes ? `<p class="text-gray-500 text-xs">Notes: ${task.Notes}</p>` : ''}
                    </li>
                `).join('');
                noRemindersMsg.classList.add('hidden');
            } else {
                reminderList.innerHTML = '';
                noRemindersMsg.classList.remove('hidden');
            }

            // Send notifications
            if ('Notification' in window && Notification.permission === 'granted') {
                upcomingTasks.forEach(task => {
                    const taskId = `${task.id}-${task.Date}-${task.Time}`;
                    if (!notifiedTasks.has(taskId)) {
                        new Notification('Upcoming Task Reminder', {
                            body: `${task.Activity} at ${task.Time}. ${task.Notes || ''}`,
                            icon: 'https://placehold.co/48x48/0000FF/FFFFFF?text=🔔' // Placeholder icon for notification
                        });
                        notifiedTasks.add(taskId);
                    }
                });
            }
        }
    </script>
</body>
</html>

